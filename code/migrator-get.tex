\begin{lstlisting}[language=Java, caption={Metode for håndtering av GET-spørring i Migrator.}]
public String getAndMigrateAggregate(StringQueryInterface db, String aggregateKey, String schema) {
    String key = this.getPersistedKey(aggregateKey, schema);
    String aggregate = db.query(key); // Blocking DB op
    AbstractAggregateTransformer spec = this.transformers.get(schema);
    if (null != spec) {
        String nextSchema = spec.getNextSchemaVersion();
        String nextKey = this.getPersistedKey(aggregateKey, nextSchema);
        CompletableFuture.supplyAsync(() -> {
            if (!aggregate.equals("")) {
                // Migrate the aggregate having the key _key to another with the key _nextKey using spec
                String migratedAggregate = spec.transformAggregate(aggregate);
                Exception fail = db.persist(nextKey, migratedAggregate);
                if (fail == null) { return true; }
                logger.error("Error during migration from " + key + " to " + nextKey + ":\n"+ fail.toString());
            }
            return false;
        }).thenAccept((b) -> {
            if (b) {
                logger.info("Migrated aggregate with key " + key + " to " + nextKey);
            }
        });
    }
    return aggregate;
}
\end{lstlisting}
